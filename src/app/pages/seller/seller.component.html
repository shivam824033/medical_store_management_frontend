<!-- Add this loader overlay near the top of your template, just inside the main container -->
<div *ngIf="isLoading" class="loader-overlay">
  <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>
<div class="container my-2">
  <div class="row p-2">
    <div class="col">
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link " id="add-product" data-bs-toggle="tab" data-bs-target="#addProduct" type="button"
            role="tab" aria-controls="addProduct" aria-selected="true">Add Product</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="sell-product" data-bs-toggle="tab" data-bs-target="#sellProduct"
            type="button" role="tab" aria-controls="sellProduct" aria-selected="false">Sell Product</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="search-product" data-bs-toggle="tab" data-bs-target="#searchProduct"
            type="button" role="tab" aria-controls="searchProduct" aria-selected="false">Search Product</button>
        </li>
      </ul>
      <div class="tab-content" id="myTabContent">

        <div class="tab-pane fade " id="addProduct" role="tabpanel" aria-labelledby="add-product">
          <section class=" py-1 py-md-1">
            <div class="container">
              <div class="row justify-content-center">
                <div class="col">
                  <div class="card border border-light-subtle rounded-3 shadow-sm">
                    <div class="container">
                      <div class="row p-2">
                        <div class="col">
                          <h2>Upload Excel (.xls)</h2>

                          <div class="row p-2">
                            <div class="col">
                              <input type="file" (change)="onFileSelected($event)" class="form-control mb-3" />

                            </div>
                            <div class="col-2">
                              <button class="btn btn-primary" (click)="uploadFile()">Upload</button>
                            </div>
                          </div>


                          <div *ngIf="progress > 0" class="mt-3">
                            <div class="progress">
                              <div class="progress-bar" role="progressbar" [style.width.%]="progress">
                                {{ progress }}%
                              </div>
                            </div>
                          </div>

                          <div class="mt-3 alert alert-info" *ngIf="message">
                            {{ message }}
                          </div>

                          <div class="alert alert-info">
                            <strong>Note:</strong> Please ensure that the CSV or Excel file follows the correct format:
                            <ul>
                              <li>Batch Number</li>
                              <li>Product Name</li>
                              <li>Expiry Date (YYYY-MM-DD)</li>
                              <li>Product Category (ID)</li>
                              <li>Quantity</li>
                              <li>Product Price</li>
                              <li>Product Description</li>
                            </ul>
                            You can download a sample file <a href="assets/sample_product_upload.xlsx"
                              download>here</a>.
                          </div>



                        </div>

                      </div>


                    </div>
                  </div>
                </div>
                <div class="col">

                  <div class="card-body">
                    <h4 class="text-center mb-4">Add Product details</h4>
                    <div class="row">
                      <div class="col">
                        <div class="form-group">
                          <label for="batchNumber">Batch Number <span style="color: red;">*</span></label>
                          <input id="batchNumber" class="form-control" type="text" required
                            [(ngModel)]="product.batchNumber" #batchNumber="ngModel" />
                          <div *ngIf="batchNumber.invalid && (batchNumber.dirty || batchNumber.touched)">
                            <div class="error" *ngIf="batchNumber.hasError('required')">
                              Batch Number is required.
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col">
                        <div class="form-group">
                          <label for="productName">Product Name <span style="color: red;">*</span></label>
                          <input id="productName" class="form-control" type="text" required
                            [(ngModel)]="product.productName" #productName="ngModel" />
                          <div *ngIf="productName.invalid && (productName.dirty || productName.touched)">
                            <div class="error" *ngIf="productName.hasError('required')">
                              Product Name is required.
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col">
                        <div class="form-group">
                          <label for="expiryDate">Expiry date<span style="color: red;">*</span></label>
                          <input id="expiryDate" type="date" class="form-control"
                            [(ngModel)]="product.productExpiryDate" #expiryDate="ngModel" />
                          <div *ngIf="expiryDate.invalid && (expiryDate.dirty || expiryDate.touched)">
                            <div class="error" *ngIf="expiryDate.hasError('required')">
                              Expiry date is required.
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col">
                        <div class="form-group">
                          <label for="productCategory">Product Category<span style="color: red;">*</span></label>
                          <select id="productCategory" class="form-select" [(ngModel)]="product.productCategory"
                            #productCategory="ngModel">
                            <option value="" disabled>Select</option>
                            <option *ngFor="let item of categories2" [value]="item.id">{{item.name}}</option>
                          </select>
                          <div *ngIf="productCategory.invalid && (productCategory.dirty || productCategory.touched)">
                            <div class="error" *ngIf="productCategory.hasError('required')">
                              Product Category is required.
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col">
                        <div class="form-group">
                          <label for="quantity">Qaunity<span style="color: red;">*</span></label>
                          <input id="quantity" type="number" class="form-control" required
                            [(ngModel)]="product.productStripCount" #quantity="ngModel" />
                          <div *ngIf="quantity.invalid && (quantity.dirty || quantity.touched)">
                            <div class="error" *ngIf="quantity.hasError('required')">
                              Qaunity is required.
                            </div>
                          </div>

                        </div>
                      </div>
                      <div class="col">
                        <div class="form-group">
                          <label for="productPerPrice"> Product Price<span style="color: red;">*</span></label>
                          <input id="productPerPrice" class="form-control" type="number" required
                            [(ngModel)]="product.productPerPrice" #productPerPrice="ngModel" />
                          <div *ngIf="productPerPrice.invalid && (productPerPrice.dirty || productPerPrice.touched)">
                            <div class="error" *ngIf="productPerPrice.hasError('required')">
                              Product Price is required.
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col">
                        <div class="form-group">
                          <label for="productDescription">Product Description <span style="color: red;">*</span></label>
                          <textarea id="productDescription" class="form-control" type="text" required
                            [(ngModel)]="product.productDescription" #productDescription="ngModel"></textarea>

                          <div
                            *ngIf="productDescription.invalid && (productDescription.dirty || productDescription.touched)">
                            <div class="error" *ngIf="productDescription.hasError('required')">
                              Product Description is required.
                            </div>
                          </div>

                        </div>
                      </div>
                    </div>
                    <div class="row mt-1">
                      <label *ngIf="errorMessage" style="color: red;">{{errorMessage}}</label>
                      <label *ngIf="successMessage" style="color: green;">{{successMessage}}</label>
                    </div>
                    <div class="row mt-1">
                      <div class="col-5">
                        <div class="d-grid my-3">
                          <button class="btn btn-primary btn-md" type="submit" (click)="addProduct('')"
                            [disabled]="addAnotherbtn">Add Product</button>
                        </div>
                      </div>
                      <div class="col" *ngIf="addAnotherbtn">
                        <div class="d-grid my-3">
                          <label style="color: blue; cursor: pointer;" (click)="addAnotherProduct()">+ Add
                            Another</label>
                        </div>
                      </div>
                    </div>
                  </div>

                </div>
              </div>
            </div>
          </section>

        </div>
        <!-- ...existing code... -->
        <div class="tab-pane fade show active" id="sellProduct" role="tabpanel" aria-labelledby="sell-product">
          <section class="py-1">
            <div class="container">
              <div class="row g-4">
                <!-- Left: Product Search & Add to Bill -->
                <div class="col-md-4">
                  <div class="card shadow-sm border-0 h-100">
                    <div class="card-body">
                      <h4 class="mb-2 text-primary"><i class="bi bi-cart-plus"></i> Sell Product / Billing</h4>
                      <form (ngSubmit)="addToBill()" #billForm="ngForm">
                        <div class=" row mb-1">
                          <label for="sellProductSearch" class="form-label"
                            style="text-align: start; font-weight: 600;">Product :</label>
                          <div class="col">
                            <input id="sellProductSearch" type="text" class="form-control"
                              [(ngModel)]="searchProductTemp" name="selectedProductName" [ngbTypeahead]="searchProduct2"
                              [resultTemplate]="rt" [inputFormatter]="formatter"
                              (selectItem)="onProductSelectForBilling($event)" placeholder="Search product..." required>
                          </div>

                        </div>
                        <div class=" row mb-1">
                          <label for="sellQuantity" class="form-label"
                            style="text-align: start; font-weight: 600;">Quantity :</label>
                          <div class="col">

                            <input id="sellQuantity" type="number" class="form-control" [(ngModel)]="sellQuantity"
                              name="sellQuantity" min="1" required>
                          </div>
                          <div class="col">
                            <button class="btn btn-success w-100" type="submit"
                              [disabled]="!selectedProduct || !sellQuantity">Add to Bill</button>
                          </div>


                        </div>
                        <div class="mb-1">

                        </div>
                      </form>
                      <div *ngIf="billSuccessMessage" class="alert alert-success mt-3">{{billSuccessMessage}}</div>
                      <div *ngIf="billErrorMessage" class="alert alert-danger mt-3">{{billErrorMessage}}</div>
                    </div>
                  </div>
                </div>
                <!-- Right: Customer Details & Bill Table -->
                <div class="col">
                  <div class="card border-0 shadow-sm mb-1">
                    <div class="card-body">
                      <div *ngIf="!invoiceViewFlag">
                        <h5 class="mb-3 text-primary">Customer Billing Details</h5>
                        <div class="d-flex align-items-end gap-3 mb-3 flex-wrap" style="text-align: start; font-weight: 600;">
                          <div>
                            <label for="customerName" class="form-label mb-1">Customer Name</label>
                            <input type="text" id="customerName" class="form-control" [(ngModel)]="customerName"
                              name="customerName" placeholder="Enter customer name">
                          </div>
                          <div>
                            <label for="customerMobile" class="form-label mb-1">Mobile Number</label>
                            <input type="text" id="customerMobile" class="form-control" [(ngModel)]="customerMobile"
                              name="customerMobile" placeholder="Enter mobile number">
                          </div>
                          <div>
                            <label for="customerAddress" class="form-label mb-1">Address</label>
                            <input type="text" id="customerAddress" class="form-control" [(ngModel)]="customerAddress"
                              name="customerAddress" placeholder="Enter address">
                          </div>
                        </div>
                      </div>
                      <!-- Invoice Preview -->
                      <div *ngIf="invoicePreview && invoiceViewFlag">
                        <div *ngIf="invoicePreview" class="invoice-preview">
                          <div class="d-flex justify-content-end mb-2">
                            <button class="btn btn-secondary me-2" (click)="backToBilling()">
                              <i class="bi bi-arrow-left"></i> Back to Billing
                            </button>
                            <button class="btn btn-outline-primary" (click)="printInvoice()">
                              <i class="bi bi-printer"></i> Print / Download PDF
                            </button>
                          </div>
                          <div id="invoiceContent">
                            <!-- ...the invoice preview card code from previous answer... -->
                            <div class="card shadow-lg">
                              <div
                                class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                                <div>
                                  <h5 class="mb-0">Invoice Preview</h5>
                                  <small>Invoice #: <strong>{{ invoicePreview.invoice.invoice_number }}</strong></small>
                                </div>
                                <div>
                                  <span class="badge bg-light text-dark">Date: {{ invoicePreview.invoice.invoice_date |
                                    date:'medium' }}</span>
                                </div>
                              </div>
                              <div class="card-body">
                                <!-- Customer Info -->
                                <div class="row mb-3">
                                  <div class="col-md-6">
                                    <h6 class="fw-bold mb-1">Customer Details</h6>
                                    <div><strong>Name:</strong> {{ invoicePreview.customer.name }}</div>
                                    <div><strong>Mobile:</strong> {{ invoicePreview.customer.mobile }}</div>
                                    <div *ngIf="customerAddress"><strong>Address:</strong> {{ customerAddress }}</div>
                                  </div>
                                  <div class="col-md-6 text-md-end mt-3 mt-md-0">
                                    <h6 class="fw-bold mb-1">Total Amount</h6>
                                    <div style="font-size: 1.5rem;" class="text-success fw-bold">
                                      ₹{{ invoicePreview.invoice.total_amount | number:'1.2-2' }}
                                    </div>
                                  </div>
                                </div>
                                <!-- Product Table -->
                                <div class="table-responsive">
                                  <table class="table table-bordered table-hover align-middle">
                                    <thead class="table-light">
                                      <tr>
                                        <th>#</th>
                                        <th>Batch Number</th>
                                        <th>Product Name</th>
                                        <th>Qty</th>
                                        <th>Price (₹)</th>
                                        <th>Discount (%)</th>
                                        <th>Subtotal (₹)</th>
                                      </tr>
                                    </thead>
                                    <tbody>
                                      <tr *ngFor="let prod of invoicePreview.products; let i = index">
                                        <td>{{ i + 1 }}</td>
                                        <td>{{ prod.batch_number }}</td>
                                        <td>{{ prod.product_name }}</td>
                                        <td>{{ prod.quantity }}</td>
                                        <td>{{ prod.price | number:'1.2-2' }}</td>
                                        <td>{{ prod.discount || 0 }}</td>
                                        <td>{{ prod.subtotal | number:'1.2-2' }}</td>
                                      </tr>
                                    </tbody>
                                  </table>
                                </div>
                                <!-- Summary -->
                                <div class="d-flex justify-content-end mt-3">
                                  <div>
                                    <div class="fw-bold">Grand Total: <span class="text-success">₹{{
                                        invoicePreview.invoice.total_amount | number:'1.2-2' }}</span></div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <!-- Bill Details Table -->
                      <div class="bill-details mt-1" *ngIf="billItems && billItems.length > 0 && !invoiceViewFlag">
                        <!-- <h5 class="mb-3 text-primary">Bill Details</h5> -->
                        <div style="max-height: 300px; overflow-y: auto;">
                          <table class="table table-bordered align-middle" style="font-size: 0.95rem;">
                            <thead class="table-light" style="position: sticky; top: 0; z-index: 1;">
                              <tr style="height: 32px;">
                                <th style="width: 18%;">Product Name</th>
                                <th style="width: 18%;">Batch Number</th>
                                <th style="width: 18%;">Expiry</th>
                                <th style="width: 10%;">Quantity</th>
                                <th style="width: 10%;">Price/Unit</th>
                                <th style="width: 10%;">Dis(%)</th>
                                <th style="width: 10%;">Subtotal</th>
                                <th style="width: 6%;">Remove</th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr *ngFor="let item of billItems; let i = index"
                                [ngClass]="{'table-danger': item.error, 'table-warning': item.warning}"
                                style="height: 32px;">
                                <td class="py-1">{{item.productName}}</td>
                                <td class="py-1">{{item.batchNumber}}</td>
                                <td class="py-1">{{item.productExpiryDate | date}}</td>
                                <td class="py-1">
                                  <input type="number" min="1" class="form-control form-control-sm"
                                    [(ngModel)]="item.quantity" name="quantity{{i}}"
                                    (ngModelChange)="onQuantityChange(i)" style="width:70px; height:28px; padding:2px 6px; font-size:0.95rem;" />
                                </td>
                                <td class="py-1">{{item.productPerPrice}}</td>
                                <td class="py-1">
                                  <input type="number" min="0" max="100" class="form-control form-control-sm"
                                    [(ngModel)]="item.discount" name="discount{{i}}" style="width:70px; height:28px; padding:2px 6px; font-size:0.95rem;" />
                                </td>
                                <td class="py-1">{{ getTotalBillPerPRoduct(item) | number:'1.2-2' }}</td>
                                <td class="py-1">
                                  <button class="btn btn-danger btn-sm py-0 px-2" style="font-size:0.9rem; height:28px;" (click)="removeBillItem(i)">X</button>
                                </td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                        <div class="text-end mb-2">
                          <h5>
                            Total: ₹{{getBillTotal() | number:'1.2-2'}}
                          </h5>
                          <button class="btn btn-primary" (click)="finalizeBill()">Finalize Bill</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- End Right -->
              </div>
            </div>
          </section>
        </div>
        <!-- ...existing code... -->
        <!-- ...existing code... -->
        <div class="tab-pane fade" id="searchProduct" role="tabpanel" aria-labelledby="search-product">
          <section>
            <div class="container py-4">
              <div class="row g-4">
                <div class="col-md-4">
                  <div class="card shadow-sm border-0 h-100">
                    <div class="card-body">
                      <h5 class="card-title mb-3 text-primary">
                        <i class="bi bi-search"></i> Search Product
                      </h5>
                      <div class="position-relative d-flex align-items-center mb-3">
                        <input id="typeahead-http" type="text" class="form-control pe-5"
                          [class.is-invalid]="searchFailed" [(ngModel)]="model" [ngbTypeahead]="searchProduct"
                          [resultTemplate]="rt" [inputFormatter]="formatter" (selectItem)="onProductselect($event)"
                          placeholder="Please enter medicine details" />

                        <!-- Clear Icon -->
                        <span *ngIf="model" class="position-absolute end-0 top-50 translate-middle-y me-3"
                          style="cursor:pointer; font-size: 1.2rem; color: #6c757d;" (click)="model = null">
                          ✕
                        </span>
                      </div>

                      <div class="mb-3">
                        <label class="form-label fw-semibold">Check Expired Products before:</label>
                        <div class="input-group">
                          <input type="date" class="form-control" [(ngModel)]="expiredProductDate">
                          <button class="btn btn-outline-secondary" type="button"
                            (click)="fetchExpiredProducts()">Fetch</button>
                        </div>
                        <div *ngIf="expiredProductError" class="text-danger mt-1">{{ expiredProductError }}</div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="col">
                  <div class="row g-3">
                    <div class="col-12" *ngIf="searchShow">
                      <div class="card shadow-sm border-0 mb-3">
                        <div class="card-header bg-info text-white fw-bold">
                          Product Details
                        </div>
                        <div class="card-body">
                          <div class="row text-center fw-semibold mb-2">
                            <div class="col">Batch Number</div>
                            <div class="col">Expiry date</div>
                            <div class="col">Quantity</div>
                            <div class="col">Price</div>
                          </div>
                          <div class="row text-center mb-3">
                            <div class="col">{{productSearchResult.batchNumber}}</div>
                            <div class="col">{{productSearchResult.productExpiryDate | date}}</div>
                            <div class="col">{{productSearchResult.productStripCount}}</div>
                            <div class="col">{{productSearchResult.productPerPrice}}</div>
                          </div>
                          <hr>
                          <div>
                            <h6 class="fw-bold mb-1">Product Name :</h6>
                            <p class="mb-2">{{productSearchResult.productName}}</p>
                            <h6 class="fw-bold mb-1">Product Description :</h6>
                            <p>{{productSearchResult.productDescription}}</p>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="col-12" *ngIf="expiryShow">
                      <div class="card shadow-sm border-0">
                        <div class="card-header bg-warning text-dark fw-bold">
                          Expired Products
                        </div>
                        <div class="card-body p-0">
                          <div style="max-height: 400px; overflow-y: auto; margin-top: 10px;"
                            *ngIf="expiredProducts.length">
                            <table class="table table-bordered table-striped mb-0">
                              <thead class="table-light">
                                <tr>
                                  <th>Product Name</th>
                                  <th>Batch Number</th>
                                  <th>Expiry Date</th>
                                  <th>Stock</th>
                                </tr>
                              </thead>
                              <tbody>
                                <tr *ngFor="let prod of expiredProducts">
                                  <td>{{ prod.product_name }}</td>
                                  <td>{{ prod.batch_number }}</td>
                                  <td>{{ prod.expiry_date | date }}</td>
                                  <td>{{ prod.strip_count }}</td>
                                </tr>
                              </tbody>
                            </table>
                          </div>
                          <div *ngIf="!expiredProducts.length" class="text-center text-muted py-3">
                            No expired products found for the selected date.
                          </div>
                        </div>
                      </div>
                    </div>
                  </div> <!-- row g-3 -->
                </div>
              </div>
            </div>
          </section>
        </div>
        <!-- ...existing code... -->
      </div>
    </div>
  </div>


  <ng-template #rt let-r="result" let-t="term">
    <div class="p-2 rounded" style="background: #f0f7fa;">
      <span class="fw-bold text-primary">{{ r.productName }}</span>
      <span class="mx-2" style="font-size: 1.1rem; color: #0b0101;">|</span>
      <span class="badge bg-info text-dark ms-2">Batch Number: {{ r.batchNumber }}</span>
      <!-- <span class="badge bg-warning text-dark ms-2">Exp: {{ r.productExpiryDate | date }}</span>
    <span class="badge bg-success ms-2">₹{{ r.productPerPrice }}</span> -->
    </div>
  </ng-template>
